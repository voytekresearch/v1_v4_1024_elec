
"""
compute power spectral density (PSD) for all LFP files in a given folder

"""

# general imports
import numpy as np
import os

# lab imports
from neurodsp.spectral import compute_spectrum

# Session to analyze
SESSIONS = ['L_SNR_250717']

# Dataset details
FS = 500 # sampling frequency (Hz)
N_ARRAYS = 16 # number of arrays
N_CHANNELS = 64 # number of channels per array

# Settings
PROJECT_PATH = 'G:/Shared drives/v1_v4_1024/'

# analysis settings
F_RANGE = [1, FS/2] # frequency range for spectral analysis - skip freq=0

def main():
    # loop through sessions of interest
    for session in SESSIONS:
        # identify/create directories
        path_in = f'{PROJECT_PATH}/data/lfp/lfp_epochs/{session}'
        path_out = f'{PROJECT_PATH}/data/lfp/lfp_psd/{session}'
        if not os.path.exists(path_out):
            os.makedirs(path_out)
            
        # loop through files
        files = os.listdir(path_in)
        for i_file, fname_in in enumerate(files):
            # show progress
            print(f'Processing file {i_file+1}/{len(files)}: \t{fname_in}')

            # load data
            data_in = np.load(f'{path_in}/{fname_in}')
            
            # compute PSD
            freq, spectra = compute_spectrum_3d(data_in[i_file], FS, f_range=F_RANGE) 

            # save results
            fname_out = fname_in.replace('.npy', '.npz')
            np.savez(f"{path_out}/{fname_out}", spectra=spectra, freq=freq)


def compute_spectrum_3d(signal, fs, f_range=None):
    # set freq range
    if f_range is None:
        f_range = [2*len(signal)/FS, fs/2]

    # loop trough trials
    spectra = []
    for i_trial in range(len(signal)):
            
        # compute spectrum
        freq, spectra_i = compute_spectrum(signal, fs, f_range=f_range)
        spectra.append(spectra_i)

    # convert to array
    spectra = np.array(spectra)

    return freq, spectra


if __name__ == "__main__":
    main()
    